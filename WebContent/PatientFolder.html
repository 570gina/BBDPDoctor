<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, height=device-height, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">

<title>BBDP</title>

<!-- Shortcut Icon -->
<link rel="Shortcut Icon" type="image/x-icon"
	href="picture/doctor-frame/icon.ico">

<!-- Bootstrap Core CSS -->
<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

<!-- MetisMenu CSS -->
<link href="vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

<!-- Custom CSS -->
<link href="dist/css/sb-admin-2.css" rel="stylesheet">

<!-- Custom Fonts -->
<link href="vendor/font-awesome/css/font-awesome.min.css"
	rel="stylesheet" type="text/css">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

<!-- jQuery -->
<!-- <script src="vendor/jquery/jquery.min.js"></script> -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<!-- 有關下拉式選單 -->
<script src="vendor/bootstrap/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<!-- 有關下拉式選單 -->
<script src="vendor/metisMenu/metisMenu.min.js"></script>

<!-- Custom Theme JavaScript -->
<!-- 有關下拉式選單 -->
<script src="dist/js/sb-admin-2.js"></script>

<!-- 醫生端框架css -->
<link href="css/doctorFrame.css" rel="stylesheet" type="text/css">


<script type="text/JavaScript">
	
	var doctorID = window.localStorage.getItem('login');
	//var doctorID = "1";
	var imgArray = [];
	var videoArray = [];
	var timeArray = [];
	var descriptionArray = [];
	var fileAmount;
	var fileYear = [];
	var fileMonth = [];
	var fileYearMonth = [];
	var uniqueYear= [];
	var uniqueYearMonth= [];
	var uniquePhotoYear= [];
	var uniquePhotoYearMonth= [];
	var uniqueVideoYear= [];
	var uniqueVideoYearMonth= [];
	
	//var serverURL = "http://localhost:8080/BBDPDoctor/PatientFolderServlet";
	var serverURL = "http://140.121.197.130:8000/BBDPDoctor/PatientFolderServlet";
	
	$(document).ready(function(){
		if(!(window.localStorage.getItem('login'))){
				//alert("您尚未登入!跳轉至登入頁面中...");
				window.location.href = 'Login.html';
			}
		else{
			initialPhotoList();	
		}			
	});
	
	function initialPhotoList(){
		$.ajax({
			type: "GET",
			url: serverURL,	 
			data: {doctorID:doctorID, option:"getDoctorFileInfo"},
			dataType: "json",
												
			success : function(response){
				showPhotoList(response);	
			},
		 
			error : function(){
				console.log("server沒有回應");
			}
		});
	}
	
	function showPhotoList(response){
		fileAmount = response.length;
		var jsonString = "";
		$("#photoList").empty();
		var output = "";
		for(var i = 0; i<fileAmount; i++){ 
			patientID = response[i]["patientID"];
			timeArray[i] = response[i]["time"];
			descriptionArray[i] = response[i]["description"];
			imgArray[i] = serverURL+"?patientID=" + patientID + "&time=" + timeArray[i] + "&option=getPhoto";
			videoArray[i] = response[i]["video"];
						
			var dateString = timeArray[i].substr(0,19);
			var date = new Date(dateString.replace(/-/g,'/')); 	// "2012/01/01 12:30:10";
												
			fileYear[i] = Number(date.getFullYear());	//年份轉整數
			fileMonth[i] = Number(date.getMonth()) + 1;	//月份轉整數
			fileYearMonth[i] = fileYear[i] + "/" + fileMonth[i];
						
			if(videoArray[i]=='null'||videoArray[i]==''){		//顯示照片
				output += photoItem(i);
			}else{	//顯示影片
				output += videoItem(i);
			}							
			//jsonString += "patientID:"+patientID+ " time:" +response[i]["time"]+"\n" + "video:" +response[i]["video"]+"\n";
		}
		//alert(jsonString);
		$("#photoList").append(output);
		//找不同年跟月
		initialUniqueTime();				
	}
	
	
	function initialUniqueTime(){
		for(var i = 0 ; i < fileAmount; i ++){					
			if(videoArray[i]==''){		
				uniquePhotoYear.push(fileYear[i]);
				uniquePhotoYearMonth.push(fileYear[i] + "/" + fileMonth[i]);	
			}
			else{
				uniqueVideoYear.push(fileYear[i]);
				uniqueVideoYearMonth.push(fileYear[i] + "/" + fileMonth[i]);
			}
		}
		uniqueYear = GetUnique(fileYear);
		uniqueYearMonth = GetUnique(fileYearMonth);
		uniquePhotoYear = GetUnique(uniquePhotoYear);
		uniquePhotoYearMonth = GetUnique(uniquePhotoYearMonth);
		uniqueVideoYear = GetUnique(uniqueVideoYear);
		uniqueVideoYearMonth = GetUnique(uniqueVideoYearMonth);
	}
	
	function photoItem(i){
		var description = "";
		if(descriptionArray[i].length > 16) {
			description = descriptionArray[i].substring(0, 16) + "...";
		}
		else{
			description = descriptionArray[i];
		}
		
		var item = "";				
		item = "<a href='#' onclick = 'showPhoto("+i+")'>" +																	
					"<div id='item' class='media'style='height:70px;'>" +
						"<div class='media-left'>" +
							"<img id='photo' class='media-object' src='" + imgArray[i] + "' >" +
						"</div>" +
						"<div class='media-body'>" +
							"<h5 class='media-heading' style='margin-top:10px;'><b>" + timeArray[i].substr(0,19) + "</b></h5>" +
							"<p>"+description+"</p>" +
						"</div>" +
					"</div>" +																		
				"</a>";	
		return item;
	}
	
	function videoItem(i){
		var description = "";
		if(descriptionArray[i].length > 16) {
			description = descriptionArray[i].substring(0, 16) + "...";
		}
		else{
			description = descriptionArray[i];
		}
	
		var item = "";			
		item = "<a href='#' onclick = 'showVideo("+i+")'>" +																	
					"<div id='item' class='media'style='height:70px;'>" +
						"<div class='media-left'>" +
							"<img id='videoIcon' src='picture/videoIcon.png'>" +
						"</div>" +
						"<div class='media-body'>" +
							"<h5 class='media-heading' style='margin-top:10px;'><b>" + timeArray[i].substr(0,19) + "</b></h5>" +
							"<p>"+description+"</p>" +
						"</div>" +
					"</div>" +																		
				"</a>";				
		return item;
	}
	
	function showVideo(i) {
		var output;
		$("#rightDiv").empty();
		output = "<div class='panel panel-default lattice right-content' style='border: 4px solid #f0f0f0;'>"+
						//影片
					"<div id='largePhoto' class='panel-heading'>"+	
						"<div style='max-width: 100%;max-height: 100%;height: auto;'>"+
							"<video controls webkit-playsinline>" + 
								"<source src='" + serverURL + "?option=getVideo&video=" + videoArray[i] + "'>"+
								"Your browser does not support the video tag."+
							"</video><br><br>"+
						"</div>"+
					"</div>"+
					//字							
					"<div class='panel-body' style='height:20vh;overflow-y:auto;'>"+
						"<span style='font-weight:bold;font-size:20px;'>" + 
							timeArray[i].substr(0,19)+
						"</span><br>" +
						"<span style='font-size:15px;'>" + 
							descriptionArray[i]+
						"</span>" +
					"</div>"+
				"</div>";
		$("#rightDiv").append(output);

    }
		
	function showPhoto(i) {
		var output;
		$("#rightDiv").empty();
		output = "<div class='panel panel-default lattice right-content' style='border: 4px solid #f0f0f0;'>"+
					//圖
					"<div id='largePhoto' class='panel-heading'>"+	
						"<img src='"+imgArray[i]+"' style='max-width: 100%;max-height: 100%;height: auto;'>"+
					"</div>"+
					//字							
					"<div class='panel-body' style='height:20vh;overflow-y:auto;'>"+
						"<span style='font-weight:bold;font-size:20px;'>" + 
							timeArray[i].substr(0,19)+
						"</span><br>" +
						"<span style='font-size:15px;'>" + 
							descriptionArray[i]+
						"</span>" +
					"</div>"+
				"</div>";
		$("#rightDiv").append(output);
    }
		
	
	
	//選類型	
	function changeFileType(){
		$("#photoList").empty();
		$("#rightDiv").empty();
		//清空下面的選單			
		$("#detailTime").empty();
		$("#selectTime").empty();
		
		var output = "";		
		var option = "<option value='allDetailTime'>所有時間</option>";
		$("#detailTime").append(option);
				
		option = "<option value=''>請選擇</option>"+
				"<option value='year'>年</option><option value='month'>年/月</option>";	
		$("#selectTime").append(option);
				
		for(var i = 0 ; i < fileAmount; i ++){
			output += filterResult(i);		
		}
		$("#photoList").append(output);
			
	}
		
	function changeTime(){
		$("#rightDiv").empty();
		var output = "";

		$("#detailTime").empty();

		var option = "<option value='allDetailTime'>所有時間</option>";
		
		if($('#fileType option:selected').val()=='all' && $('#selectTime option:selected').val()=='year'){		//選擇全部跟年		
			for(var i = 0; i < uniqueYear.length ; i++){
				option += "<option value='"+ uniqueYear[i] +"'>"+uniqueYear[i]+"</option>";				
			}						
			$("#detailTime").append(option);
		}
		else if($('#fileType option:selected').val()=='all' && $('#selectTime option:selected').val()=='month'){	//選擇全部跟年月			
			for(var i = 0; i < uniqueYearMonth.length ; i++){				
					option += "<option value='" + uniqueYearMonth[i] + "'>" + uniqueYearMonth[i]+ "</option>";		
			}						
			$("#detailTime").append(option);
		}
		else if($('#fileType option:selected').val()=='photo' && $('#selectTime option:selected').val()=='year'){	//選擇照片跟年			
			for(var i = 0; i < uniquePhotoYear.length ; i++){				
				option += "<option value='" + uniquePhotoYear[i] + "'>" + uniquePhotoYear[i]+ "</option>";		
			}						
			$("#detailTime").append(option);
			
		}
		else if($('#fileType option:selected').val()=='photo' && $('#selectTime option:selected').val()=='month'){	//選擇照片跟年月			
			for(var i = 0; i < uniquePhotoYearMonth.length ; i++){				
				option += "<option value='" + uniquePhotoYearMonth[i] + "'>" + uniquePhotoYearMonth[i]+ "</option>";		
			}						
			$("#detailTime").append(option);			
		}	
		else if($('#fileType option:selected').val()=='video' && $('#selectTime option:selected').val()=='year'){	//選擇影片跟年			
			for(var i = 0; i < uniqueVideoYear.length ; i++){				
				option += "<option value='" + uniqueVideoYear[i] + "'>" + uniqueVideoYear[i]+ "</option>";		
			}						
			$("#detailTime").append(option);
			
		}
		else if($('#fileType option:selected').val()=='video' && $('#selectTime option:selected').val()=='month'){	//選擇影片跟年月			
			for(var i = 0; i < uniqueVideoYearMonth.length ; i++){				
				option += "<option value='" + uniqueVideoYearMonth[i] + "'>" + uniqueVideoYearMonth[i]+ "</option>";		
			}						
			$("#detailTime").append(option);			
		}		
		else{
			$("#detailTime").append(option);
		}
	}	
	
	function changeDetailTime(){
		$("#rightDiv").empty();
		$("#photoList").empty();
		
		var output = "";
		for(var i = 0 ; i < fileAmount; i ++){
			var year = fileYear[i];
			var yearMonth = fileYear[i] +"/"+ fileMonth[i];
			
			if($('#detailTime option:selected').val() =="allDetailTime" ){	//選所有時間
				output += filterResult(i);			
			}
		
			if($('#detailTime option:selected').val().length == 4 && year == $('#detailTime option:selected').val()){	//選年份
				output += filterResult(i);
			}

			if($('#detailTime option:selected').val().length > 4&& yearMonth == $('#detailTime option:selected').val()){	//選年月
				output += filterResult(i);
			}
			
		}
		$("#photoList").append(output);
	}
	
	function filterResult(i){
		var result = "";
		if(videoArray[i]==''&& $('#fileType option:selected').val()=='photo'){		//選照片
			result = photoItem(i);		
		}
		else if(videoArray[i]!=''&& $('#fileType option:selected').val()=='video'){	//選影片
			result = videoItem(i);		
		}
		else if($('#fileType option:selected').val()=='all'){ //選全部
			if(videoArray[i]==''){
				result = photoItem(i);
			}
			else{
				result = videoItem(i);
			}
		}
		return 	result;		
	}
	
	function GetUnique(inputArray) {
		var outputArray = [];
		for (var i = 0; i < inputArray.length; i++) {
			if ((jQuery.inArray(inputArray[i], outputArray)) == -1) {
				outputArray.push(inputArray[i]);
			}
		}
		return outputArray;
	}
	
</script>
<style type="text/css">
	
	.col-sm-3{
		height:70px;
	}
		
	.col-sm-9{
		text-overflow: ellipsis;
		overflow : hidden;
		margin-top:5px;
	}
	a{
		text-decoration: none;color:#000000;
	}
	
	a:link{
         text-decoration: none;color:#000000;
    }

	a:visited{
		text-decoration: none;color:#000000;
	}

	a:hover{
		text-decoration: none;color:#000000;
	}

    a:active{
		text-decoration: none;color:#000000;
	}
	
	#item{
		height:70px;
		width:100%;
		margin-bottom:5px;
		text-align:left;
		background-color:#dabfff;
		vertical-align:middle;
		font-size:15px;
		border:none;
		text-overflow: ellipsis;
		overflow : hidden;
		border-radius: 5px;
	}
				
	#photo{
		margin-left:5px;
		margin-top:5px;
		width: 60px;
		height: 60px;
		object-fit: cover;
	}
				
	#videoIcon{	
		margin-left:5px;
		margin-top:5px;
		max-width: 60px;
		max-height: 60px;
	}
		
	#largePhoto{
		height:57vh;
		background-color:white;		
		border-bottom-width:0px;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	
	video {
		max-width: 100%    !important;
		max-height: 57vh   !important;
	}	
</style>

</head>

<body>

	<div id="wrapper">

		<!-- Navigation -->
		<nav class="navbar navbar-default navbar-static-top" role="navigation"
			style="margin-bottom: 0"></nav>

		<!-- page-wrapper -->
		<div id="page-wrapper">
			<div class="row">
				<div class = "col-sm-4">
					<br>
					<div class = "col-sm-12">
						<div class="panel panel-default lattice left-list" style="border: 4px solid #f0f0f0; height: 78.5vh;">
							<div class="panel-heading" style="width:100%;">
								<select class="form-control" id="fileType" onChange="changeFileType()" style="width:30%;margin-bottom:1vh;">
									<option value="all">全部</option>
									<option value="photo">照片</option>
									<option value="video">影片</option>
								</select>
								<select class="form-control" id="selectTime" onChange="changeTime()" style="float:left;width:35%;margin-right:1vh; ">
									<option value="">請選擇</option>
									<option value="year">年</option>
									<option value="month">年/月</option>
								</select>
								<select class="form-control" id="detailTime" onChange="changeDetailTime()" style="width:40%;">
									<option value="allDetailTime">所有時間</option>
								</select>									
							</div>
							<!--------------------------------------------------檔案列表------------------------------------>							
							<div id="photoList" class="panel-body" style="min-height: 65vh; max-height: 65vh; overflow-y: auto;">
							</div>
						</div>
					</div>
				</div>
				<!---------------------右邊------------------------------------->
				<br>
				<div id="rightDiv" class = "col-sm-8">
				</div>	
			</div>
		</div>

	</div>

	<!-- 醫生端框架js -->
	<script src="js/doctorFrame.js"></script>

	<!-- 醫生端病患資訊框架js -->
	<script src="js/patientInformationFrame.js"></script>

</body>

</html>
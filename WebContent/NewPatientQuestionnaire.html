<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, height=device-height, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">

<title>BBDP</title>

<!-- Shortcut Icon -->
<link rel="Shortcut Icon" type="image/x-icon"
	href="picture/doctor-frame/icon.ico">

<!-- Bootstrap Core CSS -->
<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

<!-- MetisMenu CSS -->
<link href="vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

<!-- Custom CSS -->
<link href="dist/css/sb-admin-2.css" rel="stylesheet">

<!-- Custom Fonts -->
<link href="vendor/font-awesome/css/font-awesome.min.css"
	rel="stylesheet" type="text/css">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

<!-- jQuery -->
<!-- <script src="vendor/jquery/jquery.min.js"></script> -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<!-- 有關下拉式選單 -->
<script src="vendor/bootstrap/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<!-- 有關下拉式選單 -->
<script src="vendor/metisMenu/metisMenu.min.js"></script>

<!-- Custom Theme JavaScript -->
<!-- 有關下拉式選單 -->
<script src="dist/js/sb-admin-2.js"></script>
<script src="js/patientQuestionnaireFrame.js"></script>
<!-- 醫生端框架css -->
<link href="css/doctorFrame.css" rel="stylesheet" type="text/css">

	<style type="text/css">
		.lattice {
				border: 3px solid #f0f0f0;
			}
	h5 {
	 font-weight:bold;
	 }
	 
	 a{
		text-decoration: none;color:black;
	}
	
	a:link{
           color: #000000;
    }

	a:visited{
		color: #000000;
	}

	a:hover{
		color: #000000;
	}

    a:active{
		color: #000000;
	}

	#item{
		height:70px;
		width:100%;
		margin-bottom:10px;
		text-align:left;
		vertical-align:middle;
		font-size:15px;
		border:none;
		text-overflow: ellipsis;
		overflow : hidden;
		border-radius: 5px;
	}	
	</style>

<script>
	//一進來就先判斷是否已經登入，沒有的話自動跳轉至登入頁面
	$(document).ready(function() {
		if (!(window.localStorage.getItem('login'))) {
			modalGenerator("尚未登入", "跳轉至登入頁面中...");
			window.location.href = 'Login.html';
		}
	});
</script>
	
<script>
var partNumber = 0;
var user = window.localStorage.getItem('login');		
$(document).ready(function() {
	$.ajax({
		url : "http://140.121.197.130:8000/BBDPDoctor/QuestionnaireModuleServlet",
		data : {
			state : "searchQMType",
			doctorID : user
		},
		dataType : "json",
		
		success : function(response) {
			$("#QType1").empty();
			var temp="<option value='all'>問卷模板分類</option>";
			for(var i=0;i<response.length;i++){
				temp+="<option value='"+response[i]+"'>"+response[i]+"</option>";
			}	
			temp+="</select>";
			$("#QType1").append(temp);
		},
		error : function() {
			console.log("錯誤訊息");
		}
	});
	
	$('#QType1').change(function(){
		$( "#QName" ).prop( "disabled", false );
		$.ajax({
			url : "http://140.121.197.130:8000/BBDPDoctor/QuestionnaireModuleServlet",
			data : {
				state : "selectQMType",
				selectType : $('#QType1 option:selected').val(),
				doctorID : user
			},
			dataType : "json",
			success : function(response) {
				$("#QName").empty();					
				var temp="<option value=''>請選擇問卷</option>";
				for(var i=0;i<response.length;i++){
					temp+="<option value='"+response[i]+"'>"+response[i]+"</option>";
				}	
				temp+="</select>";
				$("#QName").append(temp);

			},
			error : function() {
				console.log("錯誤訊息");
			}
		});	
	});
	
	
	$('#QName').change(function(){
		if($('#QType1 option:selected').val()!=""){
			$.ajax({
				url : "http://140.121.197.130:8000/BBDPDoctor/PatientQuestionnaireServlet",
				data : {
					state : "getQuestionnaire",
					doctorID : user,
					Qname : $('#QName option:selected').val()
				},
				dataType : "json",
				success : function(response) {
					partNumber=0;
					$('#QPview').empty();
					for(var i =0;i<response.length;i++){
						printQuestion(response[i].part,response[i].content);
					}

				},
				error : function() {
					$('#QPview').empty();
				}
			});
		}
	});
	
	
	$("#doAjaxBtn").click(function() {
		if($('#QName option:selected').val()){
			_times = $('#times').val();
			_cycleType = $('#cycleType option:selected').val();
			_totalTimes = $('#totalTimes').val();
			
			$.ajax({
				url : "http://140.121.197.130:8000/BBDPDoctor/PatientQuestionnaireServlet",
				data : {
					state : "sendQuestionnaire",
					doctorID : user,
					QName : $('#QName option:selected').val(),
					QCycle : _times,
					QCycleType : _cycleType,
					QTotalTimes : _totalTimes										
				},
				dataType : "json",
				
				success : function(response) {
					window.alert("發送成功");
					window.location.href = 'PatientQuestionnaire.html';
				},
				error : function() {
					console.log("錯誤訊息");
				}
			});
			
		}else window.alert("請選擇問卷");
	});	

});

function printQuestion(part,content){
	var temp="";
	var stringContent = content+'';
	if(part){
		partNumber+=1;
		$('#QPview').append("<div class='panel' style='border-color:#F8B1B0;width:100%;'><div class='panel-heading' style='background-color:#F8B1B0;font-weight: bold;'>Part "+partNumber+"："+part+"</div>");
	}
	if(content){
		var contentArray = stringContent.split(",");
		console.log(contentArray);
		for(var i = 0; i<contentArray.length;i++){
			$.ajax({
				url : "http://140.121.197.130:8000/BBDPDoctor/PatientQuestionnaireServlet",
				data : {
					state : "selectQP",
					doctorID : user,
					questionID : contentArray[i]
				},
				async:false,
				dataType : "json",
				success : function(response) {
					temp += "<div class='panel' style='border-color:#F8B1B0;width:100%;'><div class='panel-heading' style='background-color:#F8B1B0;'>"+response[0]+"</div>";
					 
					if(response[1]=="單選題"){
						temp+="<div class='panel-body'>";
						var obj = eval('(' + response[2] + ')');						
						for (var j = 0; j < obj.length; j++) {
							temp += obj[j].score+" = "+obj[j].content+"<br>";
						}
						temp+="</div>";						
					}
					temp +="</div>";
				
				},
				error : function() {
				
				}
			});			
		}
		$('#QPview').append(temp);
	}
	
	
}

</script>	
</head>

<body>


	<div id="wrapper">

		<!-- Navigation -->
		<nav class="navbar navbar-default navbar-static-top" role="navigation"
			style="margin-bottom: 0"></nav>

		<!-- page-wrapper -->
		<div id="page-wrapper">
			<div class="row">
				<div class = "col-sm-4">
					<br>
					<div class = "col-sm-12">
					<div>
					<button type="button" class="btn btn-default" style="background-color:#f0f0f0;font-size:13px;" disabled="disabled">新增問卷</button>
					</div>
					<br>
					    <div class="panel panel-default lattice left-list" style="border: 4px solid #f0f0f0;">
							<div class="panel-heading">							
								<form>						
									<select class="form-control" id="QType" style="width:80%;"onchange="changeQuestionnaire()">
										<option value="all">問卷分類</option>
									</select>
									<div style='height:7px;'></div>
									<select class="form-control" id="QdateRange" style="width:30%;display: inline-block;">
										<option value="all" >請選擇</option>
										<option value="year">年</option>
										<option value="month">月</option>
									</select>	
									<select class="form-control" id="Qdate" style="width:40%;display: inline-block;"onchange="changeQuestionnaire()">
										<option value="all">所有時間</option>
									</select>	
								</form>
							</div>
							<div class="panel-body" style="min-height: 60vh; max-height: 60vh; overflow-y: auto;" id="QuestionnaireList">
								
							</div>
						</div>

					</div>
				</div>
			
				<div class = "col-sm-8">
					<br>
					<div>
						<input type="button" id="doAjaxBtn" class="btn btn-default" value="送出" style="background-color:#f0f0f0;font-size:13px;float:right;">
					</div>
					<div style="height:52px;"></div>
				    <div class="panel panel-default lattice right-content" style="border: 4px solid #f0f0f0;">
						<div class="panel-heading" style="background-color:#FFFFFF;">										
							<h5>問卷模板</h5>
							<select class="form-control" id="QType1" style="width:35%;display: inline;">
								<option value="all">問卷模板分類</option>
							</select>
							<select class="form-control" disabled id="QName" style="width:35%;display: inline;">
							</select>
							
							<h5>週期</h5>
							<!--<input type="checkbox" id="addCycle" name="location">有-->
							<input type='number' class='form-control' style='width:15%;display:inline;' id='times'  min='0' max='7' value='0'>							
							<select class="form-control"id="cycleType" style="width:15%;display: inline;">
								<option value='天'selected>天</option>
								<option value='週' >週</option>
								<option value='月' >月</option>
							</select>一次，共
							<input type='number'class='form-control' style='width:15%;display:inline;' id='totalTimes'  min='1' value='1'>次
						</div>
							
						<div class="panel-body" id = 'QPview' style="min-height: 51vh; max-height: 51vh; overflow-y: auto;">
							
						</div>
					</div>	
				</div>			
			
			
			
			
						
			</div>
		</div>

	</div>


	<!-- 醫生端框架js -->
	<script src="js/doctorFrame.js"></script>

	<!-- 醫生端病患資訊框架js -->
	<script src="js/patientInformationFrame.js"></script>

</body>


</html>